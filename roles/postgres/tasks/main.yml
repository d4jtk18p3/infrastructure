- name: Setup environment
  block:
  - name: 'Create {{ working_dir }}'
    ansible.builtin.file:
      path: '{{ working_dir }}'
      state: directory
  - name: 'Create {{ working_dir }}/k8s'
    ansible.builtin.file:
      path: '{{ working_dir }}/k8s'
      state: directory
  - name: 'Create {{ storage_dir }}'
    ansible.builtin.file:
      path: '{{ storage_dir }}'
      state: directory
- name: Create data storage
  block:
  - name: 'Create {{ storage_data_0_dir }}'
    ansible.builtin.file:
      path: '{{ storage_data_0_dir }}'
      state: directory
  - name: Template a file to k8s/persistent-volume.yml
    ansible.builtin.template:
      src: k8s/persistent-volume.yml.j2
      dest: '{{ working_dir }}/k8s/persistent-volume.yml'
  - name: Apply PersistentVolumes to the cluster
    community.kubernetes.k8s:
      src: '{{ working_dir }}/k8s/persistent-volume.yml'
      state: present
- name: Setup postgres
  block:
  - name: Template a file to k8s/stateful-set.yml
    ansible.builtin.template:
      src: k8s/stateful-set.yml.j2
      dest: '{{ working_dir }}/k8s/stateful-set.yml'
  - name: Apply StatefulSet manifest to the cluster
    community.kubernetes.k8s:
      src: '{{ working_dir }}/k8s/stateful-set.yml'
      state: present
  - name: Template a file to k8s/service.yml
    ansible.builtin.template:
      src: k8s/service.yml.j2
      dest: '{{ working_dir }}/k8s/service.yml'
  - name: Apply Service manifest to the cluster
    community.kubernetes.k8s:
      src: '{{ working_dir }}/k8s/service.yml'
      state: present
